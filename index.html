<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flashcards â€“ iPhoneå‘ã‘ å‘æ€¯ãªãã‚‰ã„é€Ÿã„å˜èªå¸³</title>

<style>
  :root{
    --bg:#0f172a; /* slate-900 */
    --fg:#e5e7eb; /* gray-200 */
    --muted:#94a3b8; /* slate-400 */
    --acc:#22d3ee; /* cyan-400 */
    --card:#111827; /* gray-900 */
    --ok:#10b981;
    --warn:#f59e0b;
    --bad:#ef4444;
  }
  html,body{height:100%;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
  }
  .wrap{max-width:900px;margin:0 auto;padding:16px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls > *{
    background:#1f2937;
    color:var(--fg);
    border:1px solid #334155;
    border-radius:10px;
    padding:8px 10px;
    font-size:14px
  }
  .controls label{display:flex;gap:6px;align-items:center}
  .controls input[type="file"]{padding:6px;background:#0b1220}
  .btn{cursor:pointer;}
  .btn.primary{background:#0ea5e9;border-color:#0284c7}
  .btn.ghost{background:#0b1220}
  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
  @media (min-width:720px){.grid{grid-template-columns:1fr auto}}

  .card{
    user-select:none;
    background:linear-gradient(180deg,#0b1220,#0b0f19);
    border:1px solid #243044;
    border-radius:18px;
    padding:24px;
    min-height:42vh;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-size:28px;
    letter-spacing:.2px;
    box-shadow:0 8px 24px rgba(0,0,0,.25);
    position:relative;
    white-space:pre-wrap; /* â† æ”¹è¡Œ(\n)ã‚’ç”»é¢ã«åæ˜ ã™ã‚‹ */
    word-break:break-word;
  }

  .side{
    font-size:13px;
    color:var(--muted);
    position:absolute;
    top:10px;
    right:16px
  }
  .big{font-size: clamp(22px, 4.4vw, 36px); white-space:pre-wrap;}
  .small{font-size: clamp(16px, 3.2vw, 24px); white-space:pre-wrap;}

  .panel{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  .progress{
    height:10px;
    background:#0b1220;
    border:1px solid #243044;
    border-radius:999px;
    overflow:hidden
  }
  .bar{
    height:100%;
    width:0;
    background:linear-gradient(90deg,#22d3ee,#10b981)
  }

  .kbd{
    border:1px solid #475569;
    border-radius:8px;
    padding:2px 6px;
    font-size:12px;
    color:#cbd5e1;
    background:#0b1220
  }
  .hint{font-size:12px;color:var(--muted)}
  .stat{font-size:13px;color:#cbd5e1}
  .pill{
    font-size:12px;
    border:1px solid #475569;
    border-radius:999px;
    padding:4px 8px;
  }
  .hidden{display:none}
  a { color: #7dd3fc; }

</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Flashcards â€“ å˜èªå¸³</h1>
    <div class="controls">
      <input id="file" type="file" accept=".csv,.tsv,.txt,.json" />
      <button class="btn" id="btnSample">ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼</button>
      <button class="btn" id="btnExport">é€²æ—ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn" id="btnImport">é€²æ—ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="btn ghost" id="btnInstall" title="ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã®ã‚¬ã‚¤ãƒ‰">ãƒ›ãƒ¼ãƒ è¿½åŠ ã‚¬ã‚¤ãƒ‰</button>
    </div>
  </header>

  <div class="grid">
    <div>
      <div class="card" id="card">
        <div class="side" id="side">Front</div>
        <div id="content" class="big">ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼ˆCSV/TSVï¼šfront, back, audioUrlï¼‰\næ”¹è¡Œã¯ \\n ã¨æ›¸ã‘ã°è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="prev">â—€ï¸ å‰ (<span class="kbd">â†</span>)</button>
        <button class="btn primary" id="flip">è¡¨/è£ (<span class="kbd">Space</span>)</button>
        <button class="btn" id="next">æ¬¡ â–¶ï¸ (<span class="kbd">â†’</span>)</button>
        <span class="pill" id="counter">0 / 0</span>
        <span class="pill" id="status">â€”</span>
      </div>

      <div class="progress" aria-label="progress">
        <div class="bar" id="bar"></div>
      </div>

      <div class="row">
        <label><input type="checkbox" id="chkShuffle"> ã‚·ãƒ£ãƒƒãƒ•ãƒ«</label>
        <label><input type="checkbox" id="chkLoop"> æœ«å°¾ã§ãƒ«ãƒ¼ãƒ—</label>
        <label><input type="checkbox" id="chkAutoflip"> è‡ªå‹•ã§è£â†’æ¬¡ã¸</label>
        <label><input type="checkbox" id="chkAutoplay"> éŸ³å£°ã‚’è‡ªå‹•å†ç”Ÿ</label>
        <label><input type="checkbox" id="chkTTS"> TTSï¼ˆéŸ³å£°URLãŒãªã„ã¨ãï¼‰</label>

        <label>è¡¨ç¤ºç§’æ•°
          <input type="number" id="secFront" min="0.3" step="0.1" value="1.0" style="width:70px"> /
          <input type="number" id="secBack"  min="0.3" step="0.1" value="1.0" style="width:70px"> ç§’
        </label>

        <label>éŸ³å£°è¨€èª
          <select id="voiceLang">
            <option value="en-US">en-US</option>
            <option value="en-GB">en-GB</option>
            <option value="ja-JP">ja-JP</option>
          </select>
        </label>

        <label>è©±é€Ÿ
          <input type="number" id="voiceRate" min="0.5" max="2" step="0.1" value="1.0" style="width:70px">
        </label>
      </div>

      <div class="row">
        <button class="btn" id="unlockAudio">ğŸ”Š éŸ³ã‚’è¨±å¯</button>
      </div>

      <div class="hint">
        CSV/TSV å½¢å¼ï¼š<code>front,back,audioUrl</code>ã€‚<br>
        3000æšè¦æ¨¡ã§ã‚‚OKã€‚<br>
        frontã‚„backã®ä¸­ã« <code>\\n</code> ã¨æ›¸ãã¨æ”¹è¡Œã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
        ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼š<span class="kbd">â†</span>/<span class="kbd">â†’</span> ã§ç§»å‹•ã€
        <span class="kbd">Space</span> ã§è¡¨è£ã€‚ã‚¿ãƒƒãƒå·¦å³ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã‚‚æ“ä½œã§ãã¾ã™ã€‚
      </div>
    </div>

    <aside class="panel">
      <div class="row"><input id="search" placeholder="æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰" class="controls" style="flex:1"></div>
      <div class="row">
        <button class="btn" id="btnFilter">æ¤œç´¢ãƒ’ãƒƒãƒˆã®ã¿ã§å­¦ç¿’</button>
        <button class="btn" id="btnClearFilter">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
      </div>
      <div class="row">
        <button class="btn" id="btnReset">æœ€åˆã‹ã‚‰</button>
        <button class="btn" id="btnMarkHard">è‹¦æ‰‹ã«è¿½åŠ </button>
        <button class="btn" id="btnOnlyHard">è‹¦æ‰‹ã®ã¿</button>
        <button class="btn" id="btnClearHard">è‹¦æ‰‹ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="stat" id="stat">â€”</div>
      <details>
        <summary>ä½¿ã„æ–¹</summary>
        <ol>
          <li>CSV/TSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆåˆ—ï¼šfront, back, audioUrl ä»»æ„ï¼‰</li>
          <li>ã€ŒéŸ³å£°ã‚’è‡ªå‹•å†ç”Ÿã€ONãªã‚‰ã€è¡¨/è£ã‚’è¡¨ç¤ºã—ãŸç¬é–“ã«3åˆ—ç›®URLã®éŸ³å£°ã‚’å†ç”Ÿ</li>
          <li>3åˆ—ç›®ãŒç©ºç™½ãªã‚‰ãã®é¢ã§ã¯å†ç”Ÿã—ãªã„ã€‚TTSã‚’ONãªã‚‰åˆæˆéŸ³å£°ã‚’èª­ã‚€</li>
          <li>ã‚¹ãƒšãƒ¼ã‚¹ã§è¡¨è£ã€‚â†’ã§æ¬¡ã€â†ã§å‰ã€‚ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã‚‚æ“ä½œå¯èƒ½ã€‚</li>
          <li>é€²æ—ã‚„è¨­å®šã¯è‡ªå‹•ä¿å­˜ï¼ˆåŒãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰ã€‚</li>
          <li>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã‚¢ãƒ—ãƒªåŒ–ã§ãã¾ã™ã€‚</li>
        </ol>
      </details>
    </aside>
  </div>
</div>

<audio id="player" preload="none"></audio>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const cardEl = $('#card');
  const contentEl = $('#content');
  const sideEl = $('#side');
  const barEl = $('#bar');
  const counterEl = $('#counter');
  const statusEl = $('#status');
  const statEl = $('#stat');
  const player = $('#player');

  let deck = [];           // å…ƒãƒ‡ãƒ¼ã‚¿
  let view = [];           // è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ã‚„è‹¦æ‰‹åæ˜ ï¼‰
  let index = 0;           // ç¾åœ¨ä½ç½® (viewåŸºæº–)
  let isFront = true;      // true=è¡¨ / false=è£
  let hardSet = new Set(); // è‹¦æ‰‹ã‚«ãƒ¼ãƒ‰ (deck._id)
  let autoTimer = null;
  let touchStartX = null;

  const LSKEY = 'fc_settings_v3';

  function saveState(){
    const st = {
      index,
      isFront,
      settings: getSettings(),
      hard: Array.from(hardSet),
      viewIndices: view.map(x=>x._id).slice(0,500),
      deckCount: deck.length,
    };
    localStorage.setItem(LSKEY, JSON.stringify(st));
  }
  function loadState(){
    try{
      const st = JSON.parse(localStorage.getItem(LSKEY)||'{}');
      if(st && st.settings){
        applySettings(st.settings);
      }
      if(st && Array.isArray(st.hard)){
        hardSet = new Set(st.hard);
      }
    }catch(e){}
  }

  function getSettings(){
    return {
      shuffle:   $('#chkShuffle').checked,
      loop:      $('#chkLoop').checked,
      autoflip:  $('#chkAutoflip').checked,
      autoplay:  $('#chkAutoplay').checked,
      tts:       $('#chkTTS').checked,
      secFront:  parseFloat($('#secFront').value)||1,
      secBack:   parseFloat($('#secBack').value)||1,
      voiceLang: $('#voiceLang').value,
      voiceRate: parseFloat($('#voiceRate').value)||1,
      search:    $('#search').value
    };
  }
  function applySettings(s){
    $('#chkShuffle').checked   = !!s.shuffle;
    $('#chkLoop').checked      = !!s.loop;
    $('#chkAutoflip').checked  = !!s.autoflip;
    $('#chkAutoplay').checked  = !!s.autoplay;
    $('#chkTTS').checked       = !!s.tts;
    if(s.secFront) $('#secFront').value = s.secFront;
    if(s.secBack)  $('#secBack').value  = s.secBack;
    if(s.voiceLang) $('#voiceLang').value = s.voiceLang;
    if(s.voiceRate) $('#voiceRate').value = s.voiceRate;
    if(s.search) $('#search').value = s.search;
  }

  // æ”¹è¡Œã‚µãƒãƒ¼ãƒˆ:
  // CSVã®ä¸­ã«ã€Œ\\nã€ã¨æ›¸ã„ã¦ãŠãã¨ã€ç”»é¢è¡¨ç¤ºæ™‚ã«æœ¬ç‰©ã®æ”¹è¡Œ(\n)ã«å¤‰æ›
  function normalizeMultiline(str){
    return (str || "").replace(/\\n/g, "\n");
  }

  function parseText(txt){
    // è¡Œã”ã¨
    const lines = txt.split(/\r?\n/).filter(line => line.trim() !== "");

    // åŒºåˆ‡ã‚Šæ¨å®š
    const looksTSV = lines[0].includes("\t");
    const sep = looksTSV ? "\t" : ",";

    const out = [];

    for (let line of lines) {
      const cols = line.split(sep);

      // åˆ—: front, back, audioUrl
      const frontRaw = (cols[0] || "").trim();
      const backRaw  = (cols[1] || "").trim();
      const audioRaw = (cols[2] || "").trim();

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã£ã½ã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
      const isHeader =
        frontRaw.toLowerCase() === "front" &&
        backRaw.toLowerCase()  === "back";
      if (isHeader) continue;

      const front = normalizeMultiline(frontRaw);
      const back  = normalizeMultiline(backRaw);
      const audio = audioRaw; // URLã¯ãã®ã¾ã¾

      if (front || back) {
        out.push({ front, back, audio });
      }
    }

    return out;
  }

  function loadDeckFromText(txt){
    const arr = parseText(txt);
    deck = arr.map((x,idx)=>({ ...x, _id: idx }));
    buildView();
    index = 0;
    isFront = true;
    draw();
    toast(`${deck.length} æšã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
    saveState();
  }

  function buildView(){
    const s = getSettings();
    view = deck.slice();

    // è‹¦æ‰‹ã®ã¿
    if($('#btnOnlyHard').dataset.active==='1'){
      view = view.filter(x=>hardSet.has(x._id));
    }
    // æ¤œç´¢ãƒ’ãƒƒãƒˆã®ã¿
    if($('#btnFilter').dataset.active==='1' && s.search){
      const q = s.search.toLowerCase();
      view = view.filter(x=> (x.front+"\n"+x.back).toLowerCase().includes(q));
    }

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    if(s.shuffle){
      for(let i=view.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [view[i],view[j]] = [view[j],view[i]];
      }
    }

    updateStat();
  }

  function updateStat(){
    statEl.textContent = `å…¨${deck.length} / è¡¨ç¤º${view.length} / è‹¦æ‰‹${hardSet.size}`;
  }

  function draw(){
    if(view.length===0){
      contentEl.textContent = 'è¡¨ç¤ºå¯¾è±¡ã®ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ•ã‚£ãƒ«ã‚¿/è‹¦æ‰‹ã®ã¿ç­‰ã‚’è§£é™¤ã—ã¦ãã ã•ã„ï¼‰';
      sideEl.textContent = '';
      counterEl.textContent = '0 / 0';
      barEl.style.width = '0%';
      statusEl.textContent = 'â€”';
      return;
    }
    if(index<0) index=0;
    if(index>=view.length) index=view.length-1;

    const c = view[index];

    // é¢ã®ãƒ†ã‚­ã‚¹ãƒˆ
    if (isFront) {
      contentEl.textContent = c.front || '(ç©º)';
      contentEl.className = 'big';
      sideEl.textContent = 'Front';
      statusEl.textContent = 'è¡¨';
    } else {
      contentEl.textContent = c.back || '(ç©º)';
      contentEl.className = 'small';
      sideEl.textContent = 'Back';
      statusEl.textContent = 'è£';
    }

    counterEl.textContent = `${index+1} / ${view.length}`;
    barEl.style.width = `${((index+1)/view.length)*100}%`;
  }

  function speakTTS(text){
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = $('#voiceLang').value;
    u.rate = parseFloat($('#voiceRate').value)||1;
    window.speechSynthesis.speak(u);
  }

  // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é¢ã«åˆã‚ã›ã¦éŸ³ã‚’é³´ã‚‰ã™
  function playForCurrentSide(){
    const s = getSettings();
    if(!s.autoplay) return; // è‡ªå‹•å†ç”ŸOFFãªã‚‰ä½•ã‚‚ã—ãªã„

    const c = view[index];
    if(!c) return;

    // audioåˆ—ï¼ˆ3åˆ—ç›®ï¼‰ãŒç©ºãªã‚‰ã€TTS fallbackã™ã‚‹ã‹ã©ã†ã‹æ±ºã‚ã‚‹
    if (c.audio) {
      try {
        player.src = c.audio;
        player.currentTime = 0;
        player.play().catch(()=>{});
      } catch(e){}
    } else if (s.tts) {
      // é¢ã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã‚€
      const txt = isFront ? (c.front||"") : (c.back||"");
      if (txt.trim() !== "") {
        speakTTS(txt);
      }
    }
  }

  function flip(){
    if(view.length===0) return;
    isFront = !isFront;
    draw();
    playForCurrentSide(); // ã²ã£ãã‚Šè¿”ã—ãŸé¢ã«å¯¾å¿œã™ã‚‹éŸ³

    const s = getSettings();
    if(!isFront){
      // è£ã‚’è¦‹ã›ãŸç›´å¾Œã«ã‚ªãƒ¼ãƒˆãƒ•ãƒªãƒƒãƒ—äºˆç´„
      if(s.autoflip){
        clearTimeout(autoTimer);
        autoTimer = setTimeout(()=>{ next(); }, Math.max(200, s.secBack*1000));
      }
    }
    saveState();
  }

  function next(){
    if(view.length===0) return;
    const s = getSettings();

    if(isFront){
      // ã¾ãšè£ã‚’è¦‹ã›ã‚‹
      isFront=false;
      draw();
      playForCurrentSide(); // è£å´ã®éŸ³
      if(s.autoflip){
        clearTimeout(autoTimer);
        autoTimer = setTimeout(()=>{ next(); }, Math.max(200, s.secBack*1000));
      }
      saveState();
      return;
    }

    // ã“ã“ã«æ¥ãŸã‚‰ã€Œè£ã‚’è¦‹çµ‚ã‚ã£ãŸã®ã§æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã¸ã€
    isFront=true;
    if(index<view.length-1){
      index++;
    }else if(getSettings().loop){
      index=0;
    }
    draw();
    playForCurrentSide(); // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã®è¡¨ã®éŸ³
    if(s.autoflip){
      clearTimeout(autoTimer);
      autoTimer = setTimeout(()=>{ flip(); }, Math.max(200, s.secFront*1000));
    }
    saveState();
  }

  function prev(){
    if(view.length===0) return;
    isFront=true;
    if(index>0){
      index--;
    }
    draw();
    playForCurrentSide(); // æˆ»ã£ãŸã‚«ãƒ¼ãƒ‰ã®è¡¨ã®éŸ³
    saveState();
  }

  // Safariã«ã€ŒéŸ³ã‚’é³´ã‚‰ã—ã¦ã„ã„ã‚ˆã€ã¨ã„ã†è¨±å¯ã‚’ä¸ãˆã‚‹ãƒœã‚¿ãƒ³
  $('#unlockAudio').addEventListener('click', ()=>{
    const c = view[index];
    if(!c) return;
    // audio ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã£ã¦1å›å†ç”Ÿã—ã¦æ¨©é™ã‚’ç¢ºç«‹
    if(c.audio){
      try {
        player.src = c.audio;
        player.currentTime = 0;
        player.play().catch(()=>{});
      } catch(e){}
    } else {
      // audioãŒç©ºã§TTSã‚ªãƒ³ãªã‚‰TTSã‚’1å›ã—ã‚ƒã¹ã‚‰ã›ã¦æ¨©é™ã‚’ç¢ºç«‹
      const s = getSettings();
      if(s.tts){
        const txt = isFront ? (c.front||"") : (c.back||"");
        if (txt.trim() !== "") {
          speakTTS(txt);
        }
      }
    }
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
  $('#file').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const txt = await f.text();
    loadDeckFromText(txt);
  });

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼
  $('#btnSample').addEventListener('click', ()=>{
    const sample = [
      "front,back,audioUrl",
      "ability,èƒ½åŠ›,https://ssl.gstatic.com/dictionary/static/sounds/20200429/ability--_us_1.mp3",
      "achieve,é”æˆã™ã‚‹,https://ssl.gstatic.com/dictionary/static/sounds/20200429/achieve--_us_1.mp3",
      "acquire,ç¿’å¾—ã™ã‚‹,https://ssl.gstatic.com/dictionary/static/sounds/20200429/acquire--_us_1.mp3",
      "adapt,é©å¿œã™ã‚‹,https://ssl.gstatic.com/dictionary/static/sounds/20200429/adapt--_us_1.mp3",
      "adjust,èª¿æ•´ã™ã‚‹,https://ssl.gstatic.com/dictionary/static/sounds/20200429/adjust--_us_1.mp3",
      "analyze,åˆ†æã™ã‚‹,https://ssl.gstatic.com/dictionary/static/sounds/20200429/analyze--_us_1.mp3",
      "announce,ç™ºè¡¨ã™ã‚‹,https://ssl.gstatic.com/dictionary/static/sounds/20200429/announce--_us_1.mp3",
      "apply,å¿œç”¨ã™ã‚‹ï¼ç”³ã—è¾¼ã‚€,https://ssl.gstatic.com/dictionary/static/sounds/20200429/apply--_us_1.mp3",
      "arrange,æ‰‹é…ã™ã‚‹,https://ssl.gstatic.com/dictionary/static/sounds/20200429/arrange--_us_1.mp3"
    ].join("\n");
    loadDeckFromText(sample);
  });

  $('#btnReset').addEventListener('click', ()=>{
    index=0;
    isFront=true;
    draw();
    playForCurrentSide();
    saveState();
  });

  $('#btnMarkHard').addEventListener('click', ()=>{
    const c=view[index];
    if(c){
      hardSet.add(c._id);
      updateStat();
      saveState();
      toast('è‹¦æ‰‹ã«è¿½åŠ ');
    }
  });

  $('#btnOnlyHard').addEventListener('click',(ev)=>{
    ev.target.dataset.active = ev.target.dataset.active==='1'?'0':'1';
    buildView();
    index=0;
    isFront=true;
    draw();
    playForCurrentSide();
    saveState();
  });

  $('#btnClearHard').addEventListener('click',()=>{
    hardSet.clear();
    updateStat();
    saveState();
    toast('è‹¦æ‰‹ã‚’ã‚¯ãƒªã‚¢');
  });

  $('#btnFilter').addEventListener('click',(ev)=>{
    ev.target.dataset.active = ev.target.dataset.active==='1'?'0':'1';
    buildView();
    index=0;
    isFront=true;
    draw();
    playForCurrentSide();
    saveState();
  });

  $('#btnClearFilter').addEventListener('click',()=>{
    $('#search').value='';
    $('#btnFilter').dataset.active='0';
    buildView();
    index=0;
    isFront=true;
    draw();
    playForCurrentSide();
    saveState();
  });

  $('#search').addEventListener('input',()=>{ /* ãƒ•ã‚£ãƒ«ã‚¿ç¢ºå®šã¯btnFilter */ });

  $('#prev').addEventListener('click', prev);
  $('#flip').addEventListener('click', flip);
  $('#next').addEventListener('click', next);

  [
    'chkShuffle','chkLoop','chkAutoflip','chkAutoplay','chkTTS',
    'secFront','secBack','voiceLang','voiceRate'
  ].forEach(id=>{
    $('#'+id).addEventListener('change', ()=>{
      buildView();
      draw();
      playForCurrentSide();
      saveState();
    });
  });

  // keyboard
  window.addEventListener('keydown',(e)=>{
    if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if(e.code==='ArrowRight'){ e.preventDefault(); next(); }
    if(e.code==='ArrowLeft'){  e.preventDefault(); prev(); }
    if(e.code==='Space'){      e.preventDefault(); flip(); }
  });

  // swipe
  cardEl.addEventListener('touchstart',(e)=>{
    touchStartX = e.changedTouches[0].clientX;
  },{passive:true});
  cardEl.addEventListener('touchend',(e)=>{
    if(touchStartX==null) return;
    const dx = e.changedTouches[0].clientX - touchStartX;
    touchStartX=null;
    if(Math.abs(dx)>50){
      if(dx<0) next();
      else prev();
    }
  },{passive:true});

  // export/import of local progress
  $('#btnExport').addEventListener('click',()=>{
    const blob = new Blob([localStorage.getItem(LSKEY)||'{}'], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download='flashcards_progress.json';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url),5000);
  });

  $('#btnImport').addEventListener('click',()=>{
    const inp = document.createElement('input');
    inp.type='file';
    inp.accept='.json';
    inp.onchange = async ()=>{
      const f = inp.files[0];
      if(!f) return;
      const js = await f.text();
      localStorage.setItem(LSKEY, js);
      loadState();
      buildView();
      index=0;
      isFront=true;
      draw();
      playForCurrentSide();
      toast('é€²æ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    };
    inp.click();
  });

  $('#btnInstall').addEventListener('click',()=>{
    alert(
      'ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ï¼ˆiPhone Safariï¼‰ã€‘\n' +
      '1) å…±æœ‰ãƒœã‚¿ãƒ³ â†’ 2) ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€â†’ 3) åå‰ã‚’æ±ºã‚ã¦è¿½åŠ \n' +
      'ã“ã®ãƒšãƒ¼ã‚¸ã‚’å…¬é–‹URLã§Safariã‹ã‚‰é–‹ã„ãŸçŠ¶æ…‹ã§ã‚„ã£ã¦ãã ã•ã„ã€‚'
    );
  });

  function toast(msg){
    statusEl.textContent = msg;
    setTimeout(()=>{
      statusEl.textContent = isFront?'è¡¨':'è£';
    },1600);
  }

  // init
  loadState();
  draw();
})();
</script>
</body>
</html>
